module.exports=function(e,t,i,r,n,o){var a=e._getDomain,l=require("./util"),s=l.tryCatch;function ReductionPromiseArray(t,i,r,o){this.constructor$(t);var s=a();this._fn=null===s?i:l.domainBind(s,i),void 0!==r&&(r=e.resolve(r))._attachCancellationCallback(this),this._initialValue=r,this._currentCancellable=null,this._eachValues=o===n?Array(this._length):0===o?null:void 0,this._promise._captureStackTrace(),this._init$(void 0,-5)}function completed(e,t){this.isFulfilled()?t._resolve(e):t._reject(e)}function reduce(e,t,r,n){return"function"!=typeof t?i("expecting a function but got "+l.classString(t)):new ReductionPromiseArray(e,t,r,n).promise()}function gotAccum(t){this.accum=t,this.array._gotAccum(t);var i=r(this.value,this.array._promise);return i instanceof e?(this.array._currentCancellable=i,i._then(gotValue,void 0,void 0,this,void 0)):gotValue.call(this,i)}function gotValue(t){var i,r=this.array,n=r._promise,a=s(r._fn);n._pushContext(),(i=void 0!==r._eachValues?a.call(n._boundValue(),t,this.index,this.length):a.call(n._boundValue(),this.accum,t,this.index,this.length))instanceof e&&(r._currentCancellable=i);var l=n._popContext();return o.checkForgottenReturns(i,l,void 0!==r._eachValues?"Promise.each":"Promise.reduce",n),i}l.inherits(ReductionPromiseArray,t),ReductionPromiseArray.prototype._gotAccum=function(e){void 0!==this._eachValues&&null!==this._eachValues&&e!==n&&this._eachValues.push(e)},ReductionPromiseArray.prototype._eachComplete=function(e){return null!==this._eachValues&&this._eachValues.push(e),this._eachValues},ReductionPromiseArray.prototype._init=function(){},ReductionPromiseArray.prototype._resolveEmptyArray=function(){this._resolve(void 0!==this._eachValues?this._eachValues:this._initialValue)},ReductionPromiseArray.prototype.shouldCopyValues=function(){return!1},ReductionPromiseArray.prototype._resolve=function(e){this._promise._resolveCallback(e),this._values=null},ReductionPromiseArray.prototype._resultCancelled=function(t){if(t===this._initialValue)return this._cancel();this._isResolved()||(this._resultCancelled$(),this._currentCancellable instanceof e&&this._currentCancellable.cancel(),this._initialValue instanceof e&&this._initialValue.cancel())},ReductionPromiseArray.prototype._iterate=function(t){var i,r;this._values=t;var n=t.length;if(void 0!==this._initialValue?(i=this._initialValue,r=0):(i=e.resolve(t[0]),r=1),this._currentCancellable=i,!i.isRejected())for(;r<n;++r){var o={accum:null,value:t[r],index:r,length:n,array:this};i=i._then(gotAccum,void 0,void 0,o,void 0)}void 0!==this._eachValues&&(i=i._then(this._eachComplete,void 0,void 0,this,void 0)),i._then(completed,completed,void 0,i,this)},e.prototype.reduce=function(e,t){return reduce(this,e,t,null)},e.reduce=function(e,t,i,r){return reduce(e,t,i,r)}};