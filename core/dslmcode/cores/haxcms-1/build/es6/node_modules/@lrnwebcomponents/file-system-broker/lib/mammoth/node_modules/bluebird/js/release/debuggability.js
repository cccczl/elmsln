module.exports=function(e,t){var n,r,a,o=e._getDomain,i=e._async,c=require("./errors").Warning,s=require("./util"),l=s.canAttachTrace,u=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/,f=/\((?:timers\.js):\d+:\d+\)/,p=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/,d=null,h=null,v=!1,g=!(0==s.env("BLUEBIRD_DEBUG")||!s.env("BLUEBIRD_DEBUG")&&"development"!==s.env("NODE_ENV")),_=!(0==s.env("BLUEBIRD_WARNINGS")||!g&&!s.env("BLUEBIRD_WARNINGS")),m=!(0==s.env("BLUEBIRD_LONG_STACK_TRACES")||!g&&!s.env("BLUEBIRD_LONG_STACK_TRACES")),k=0!=s.env("BLUEBIRD_W_FORGOTTEN_RETURN")&&(_||!!s.env("BLUEBIRD_W_FORGOTTEN_RETURN"));e.prototype.suppressUnhandledRejections=function(){var e=this._target();e._bitField=-1048577&e._bitField|524288},e.prototype._ensurePossibleRejectionHandled=function(){0==(524288&this._bitField)&&(this._setRejectionIsUnhandled(),i.invokeLater(this._notifyUnhandledRejection,this,void 0))},e.prototype._notifyUnhandledRejectionIsHandled=function(){fireRejectionEvent("rejectionHandled",n,void 0,this)},e.prototype._setReturnedNonUndefined=function(){this._bitField=268435456|this._bitField},e.prototype._returnedNonUndefined=function(){return 0!=(268435456&this._bitField)},e.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var e=this._settledValue();this._setUnhandledRejectionIsNotified(),fireRejectionEvent("unhandledRejection",r,e,this)}},e.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=262144|this._bitField},e.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-262145&this._bitField},e.prototype._isUnhandledRejectionNotified=function(){return(262144&this._bitField)>0},e.prototype._setRejectionIsUnhandled=function(){this._bitField=1048576|this._bitField},e.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-1048577&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},e.prototype._isRejectionUnhandled=function(){return(1048576&this._bitField)>0},e.prototype._warn=function(e,t,n){return warn(e,t,n||this)},e.onPossiblyUnhandledRejection=function(e){var t=o();r="function"==typeof e?null===t?e:s.domainBind(t,e):void 0},e.onUnhandledRejectionHandled=function(e){var t=o();n="function"==typeof e?null===t?e:s.domainBind(t,e):void 0};var disableLongStackTraces=function(){};e.longStackTraces=function(){if(i.haveItemsQueued()&&!w.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");if(!w.longStackTraces&&longStackTracesIsSupported()){var n=e.prototype._captureStackTrace,r=e.prototype._attachExtraTrace;w.longStackTraces=!0,disableLongStackTraces=function(){if(i.haveItemsQueued()&&!w.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");e.prototype._captureStackTrace=n,e.prototype._attachExtraTrace=r,t.deactivateLongStackTraces(),i.enableTrampoline(),w.longStackTraces=!1},e.prototype._captureStackTrace=longStackTracesCaptureStackTrace,e.prototype._attachExtraTrace=longStackTracesAttachExtraTrace,t.activateLongStackTraces(),i.disableTrampolineIfNecessary()}},e.hasLongStackTraces=function(){return w.longStackTraces&&longStackTracesIsSupported()};var y=function(){try{if("function"==typeof CustomEvent){var e=new CustomEvent("CustomEvent");return s.global.dispatchEvent(e),function(e,t){var n=new CustomEvent(e.toLowerCase(),{detail:t,cancelable:!0});return!s.global.dispatchEvent(n)}}if("function"==typeof Event){e=new Event("CustomEvent");return s.global.dispatchEvent(e),function(e,t){var n=new Event(e.toLowerCase(),{cancelable:!0});return n.detail=t,!s.global.dispatchEvent(n)}}return(e=document.createEvent("CustomEvent")).initCustomEvent("testingtheevent",!1,!0,{}),s.global.dispatchEvent(e),function(e,t){var n=document.createEvent("CustomEvent");return n.initCustomEvent(e.toLowerCase(),!1,!0,t),!s.global.dispatchEvent(n)}}catch(e){}return function(){return!1}}(),E=s.isNode?function(){return process.emit.apply(process,arguments)}:s.global?function(e){var t="on"+e.toLowerCase(),n=s.global[t];return!!n&&(n.apply(s.global,[].slice.call(arguments,1)),!0)}:function(){return!1};function generatePromiseLifecycleEventObject(e,t){return{promise:t}}var T={promiseCreated:generatePromiseLifecycleEventObject,promiseFulfilled:generatePromiseLifecycleEventObject,promiseRejected:generatePromiseLifecycleEventObject,promiseResolved:generatePromiseLifecycleEventObject,promiseCancelled:generatePromiseLifecycleEventObject,promiseChained:function(e,t,n){return{promise:t,child:n}},warning:function(e,t){return{warning:t}},unhandledRejection:function(e,t,n){return{reason:t,promise:n}},rejectionHandled:generatePromiseLifecycleEventObject},activeFireEvent=function(e){var t=!1;try{t=E.apply(null,arguments)}catch(e){i.throwLater(e),t=!0}var n=!1;try{n=y(e,T[e].apply(null,arguments))}catch(e){i.throwLater(e),n=!0}return n||t};function defaultFireEvent(){return!1}function cancellationExecute(e,t,n){var r=this;try{e(t,n,(function(e){if("function"!=typeof e)throw new TypeError("onCancel must be a function, got: "+s.toString(e));r._attachCancellationCallback(e)}))}catch(e){return e}}function cancellationAttachCancellationCallback(e){if(!this._isCancellable())return this;var t=this._onCancel();void 0!==t?s.isArray(t)?t.push(e):this._setOnCancel([t,e]):this._setOnCancel(e)}function cancellationOnCancel(){return this._onCancelField}function cancellationSetOnCancel(e){this._onCancelField=e}function cancellationClearCancellationData(){this._cancellationParent=void 0,this._onCancelField=void 0}function cancellationPropagateFrom(e,t){if(0!=(1&t)){this._cancellationParent=e;var n=e._branchesRemainingToCancel;void 0===n&&(n=0),e._branchesRemainingToCancel=n+1}0!=(2&t)&&e._isBound()&&this._setBoundTo(e._boundTo)}e.config=function(t){if("longStackTraces"in(t=Object(t))&&(t.longStackTraces?e.longStackTraces():!t.longStackTraces&&e.hasLongStackTraces()&&disableLongStackTraces()),"warnings"in t){var n=t.warnings;w.warnings=!!n,k=w.warnings,s.isObject(n)&&"wForgottenReturn"in n&&(k=!!n.wForgottenReturn)}if("cancellation"in t&&t.cancellation&&!w.cancellation){if(i.haveItemsQueued())throw new Error("cannot enable cancellation after promises are in use");e.prototype._clearCancellationData=cancellationClearCancellationData,e.prototype._propagateFrom=cancellationPropagateFrom,e.prototype._onCancel=cancellationOnCancel,e.prototype._setOnCancel=cancellationSetOnCancel,e.prototype._attachCancellationCallback=cancellationAttachCancellationCallback,e.prototype._execute=cancellationExecute,b=cancellationPropagateFrom,w.cancellation=!0}return"monitoring"in t&&(t.monitoring&&!w.monitoring?(w.monitoring=!0,e.prototype._fireEvent=activeFireEvent):!t.monitoring&&w.monitoring&&(w.monitoring=!1,e.prototype._fireEvent=defaultFireEvent)),e},e.prototype._fireEvent=defaultFireEvent,e.prototype._execute=function(e,t,n){try{e(t,n)}catch(e){return e}},e.prototype._onCancel=function(){},e.prototype._setOnCancel=function(e){},e.prototype._attachCancellationCallback=function(e){},e.prototype._captureStackTrace=function(){},e.prototype._attachExtraTrace=function(){},e.prototype._clearCancellationData=function(){},e.prototype._propagateFrom=function(e,t){};var b=function bindingPropagateFrom(e,t){0!=(2&t)&&e._isBound()&&this._setBoundTo(e._boundTo)};function boundValueFunction(){var t=this._boundTo;return void 0!==t&&t instanceof e?t.isFulfilled()?t.value():void 0:t}function longStackTracesCaptureStackTrace(){this._trace=new CapturedTrace(this._peekContext())}function longStackTracesAttachExtraTrace(e,t){if(l(e)){var n=this._trace;if(void 0!==n&&t&&(n=n._parent),void 0!==n)n.attachExtraTrace(e);else if(!e.__stackCleaned__){var r=parseStackAndMessage(e);s.notEnumerableProp(e,"stack",r.message+"\n"+r.stack.join("\n")),s.notEnumerableProp(e,"__stackCleaned__",!0)}}}function warn(t,n,r){if(w.warnings){var a,o=new c(t);if(n)r._attachExtraTrace(o);else if(w.longStackTraces&&(a=e._peekContext()))a.attachExtraTrace(o);else{var i=parseStackAndMessage(o);o.stack=i.message+"\n"+i.stack.join("\n")}activeFireEvent("warning",o)||formatAndLogError(o,"",!0)}}function cleanStack(e){for(var t=[],n=0;n<e.length;++n){var r=e[n],a="    (No stack trace)"===r||d.test(r),o=a&&shouldIgnore(r);a&&!o&&(v&&" "!==r.charAt(0)&&(r="    "+r),t.push(r))}return t}function parseStackAndMessage(e){var t=e.stack,n=e.toString();return t="string"==typeof t&&t.length>0?function stackFramesAsArray(e){for(var t=e.stack.replace(/\s+$/g,"").split("\n"),n=0;n<t.length;++n){var r=t[n];if("    (No stack trace)"===r||d.test(r))break}return n>0&&"SyntaxError"!=e.name&&(t=t.slice(n)),t}(e):["    (No stack trace)"],{message:n,stack:"SyntaxError"==e.name?t:cleanStack(t)}}function formatAndLogError(e,t,n){if("undefined"!=typeof console){var r;if(s.isObject(e)){var o=e.stack;r=t+h(o,e)}else r=t+String(e);"function"==typeof a?a(r,n):"function"!=typeof console.log&&"object"!=typeof console.log||console.log(r)}}function fireRejectionEvent(e,t,n,r){var a=!1;try{"function"==typeof t&&(a=!0,"rejectionHandled"===e?t(r):t(n,r))}catch(e){i.throwLater(e)}"unhandledRejection"===e?activeFireEvent(e,n,r)||a||formatAndLogError(n,"Unhandled rejection "):activeFireEvent(e,r)}function formatNonError(e){var t;if("function"==typeof e)t="[function "+(e.name||"anonymous")+"]";else{t=e&&"function"==typeof e.toString?e.toString():s.toString(e);if(/\[object [a-zA-Z0-9$_]+\]/.test(t))try{t=JSON.stringify(e)}catch(e){}0===t.length&&(t="(empty array)")}return"(<"+function snip(e){var t=41;if(e.length<t)return e;return e.substr(0,t-3)+"..."}(t)+">, no stack trace)"}function longStackTracesIsSupported(){return"function"==typeof S}var shouldIgnore=function(){return!1},C=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;function parseLineInfo(e){var t=e.match(C);if(t)return{fileName:t[1],line:parseInt(t[2],10)}}function CapturedTrace(e){this._parent=e,this._promisesCreated=0;var t=this._length=1+(void 0===e?0:e._length);S(this,CapturedTrace),t>32&&this.uncycle()}s.inherits(CapturedTrace,Error),t.CapturedTrace=CapturedTrace,CapturedTrace.prototype.uncycle=function(){var e=this._length;if(!(e<2)){for(var t=[],n={},r=0,a=this;void 0!==a;++r)t.push(a),a=a._parent;for(r=(e=this._length=r)-1;r>=0;--r){var o=t[r].stack;void 0===n[o]&&(n[o]=r)}for(r=0;r<e;++r){var i=n[t[r].stack];if(void 0!==i&&i!==r){i>0&&(t[i-1]._parent=void 0,t[i-1]._length=1),t[r]._parent=void 0,t[r]._length=1;var c=r>0?t[r-1]:this;i<e-1?(c._parent=t[i+1],c._parent.uncycle(),c._length=c._parent._length+1):(c._parent=void 0,c._length=1);for(var s=c._length+1,l=r-2;l>=0;--l)t[l]._length=s,s++;return}}}},CapturedTrace.prototype.attachExtraTrace=function(e){if(!e.__stackCleaned__){this.uncycle();for(var t=parseStackAndMessage(e),n=t.message,r=[t.stack],a=this;void 0!==a;)r.push(cleanStack(a.stack.split("\n"))),a=a._parent;!function removeCommonRoots(e){for(var t=e[0],n=1;n<e.length;++n){for(var r=e[n],a=t.length-1,o=t[a],i=-1,c=r.length-1;c>=0;--c)if(r[c]===o){i=c;break}for(c=i;c>=0;--c){var s=r[c];if(t[a]!==s)break;t.pop(),a--}t=r}}(r),function removeDuplicateOrEmptyJumps(e){for(var t=0;t<e.length;++t)(0===e[t].length||t+1<e.length&&e[t][0]===e[t+1][0])&&(e.splice(t,1),t--)}(r),s.notEnumerableProp(e,"stack",function reconstructStack(e,t){for(var n=0;n<t.length-1;++n)t[n].push("From previous event:"),t[n]=t[n].join("\n");return n<t.length&&(t[n]=t[n].join("\n")),e+"\n"+t.join("\n")}(n,r)),s.notEnumerableProp(e,"__stackCleaned__",!0)}};var S=function stackDetection(){var e=/^\s*at\s*/,v8stackFormatter=function(e,t){return"string"==typeof e?e:void 0!==t.name&&void 0!==t.message?t.toString():formatNonError(t)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit+=6,d=e,h=v8stackFormatter;var t=Error.captureStackTrace;return shouldIgnore=function(e){return u.test(e)},function(e,n){Error.stackTraceLimit+=6,t(e,n),Error.stackTraceLimit-=6}}var n,r=new Error;if("string"==typeof r.stack&&r.stack.split("\n")[0].indexOf("stackDetection@")>=0)return d=/@/,h=v8stackFormatter,v=!0,function captureStackTrace(e){e.stack=(new Error).stack};try{throw new Error}catch(e){n="stack"in e}return!("stack"in r)&&n&&"number"==typeof Error.stackTraceLimit?(d=e,h=v8stackFormatter,function captureStackTrace(e){Error.stackTraceLimit+=6;try{throw new Error}catch(t){e.stack=t.stack}Error.stackTraceLimit-=6}):(h=function(e,t){return"string"==typeof e?e:"object"!=typeof t&&"function"!=typeof t||void 0===t.name||void 0===t.message?formatNonError(t):t.toString()},null)}();"undefined"!=typeof console&&void 0!==console.warn&&(a=function(e){console.warn(e)},s.isNode&&process.stderr.isTTY?a=function(e,t){var n=t?"[33m":"[31m";console.warn(n+e+"[0m\n")}:s.isNode||"string"!=typeof(new Error).stack||(a=function(e,t){console.warn("%c"+e,t?"color: darkorange":"color: red")}));var w={warnings:_,longStackTraces:!1,cancellation:!1,monitoring:!1};return m&&e.longStackTraces(),{longStackTraces:function(){return w.longStackTraces},warnings:function(){return w.warnings},cancellation:function(){return w.cancellation},monitoring:function(){return w.monitoring},propagateFromFunction:function(){return b},boundValueFunction:function(){return boundValueFunction},checkForgottenReturns:function checkForgottenReturns(e,t,n,r,a){if(void 0===e&&null!==t&&k){if(void 0!==a&&a._returnedNonUndefined())return;if(0==(65535&r._bitField))return;n&&(n+=" ");var o="",i="";if(t._trace){for(var c=t._trace.stack.split("\n"),s=cleanStack(c),l=s.length-1;l>=0;--l){var u=s[l];if(!f.test(u)){var d=u.match(p);d&&(o="at "+d[1]+":"+d[2]+":"+d[3]+" ");break}}if(s.length>0){var h=s[0];for(l=0;l<c.length;++l)if(c[l]===h){l>0&&(i="\n"+c[l-1]);break}}}var v="a promise was created in a "+n+"handler "+o+"but was not returned from it, see http://goo.gl/rRqMUw"+i;r._warn(v,!0,t)}},setBounds:function setBounds(e,t){if(longStackTracesIsSupported()){for(var n,r,a=e.stack.split("\n"),o=t.stack.split("\n"),i=-1,c=-1,s=0;s<a.length;++s){if(l=parseLineInfo(a[s])){n=l.fileName,i=l.line;break}}for(s=0;s<o.length;++s){var l;if(l=parseLineInfo(o[s])){r=l.fileName,c=l.line;break}}i<0||c<0||!n||!r||n!==r||i>=c||(shouldIgnore=function(e){if(u.test(e))return!0;var t=parseLineInfo(e);return!!(t&&t.fileName===n&&i<=t.line&&t.line<=c)})}},warn,deprecated:function deprecated(e,t){var n=e+" is deprecated and will be removed in a future version.";return t&&(n+=" Use "+t+" instead."),warn(n)},CapturedTrace,fireDomEvent:y,fireGlobalEvent:E}};