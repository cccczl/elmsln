/**
 * Copyright 2021 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{html as e,css as t,LitElement as i}from"../../lit/index.js";import{SchemaBehaviors as a}from"../schema-behaviors/schema-behaviors.js";import{IntersectionObserverMixin as n}from"../intersection-element/lib/IntersectionObserverMixin.js";import{I18NMixin as r}from"../i18n-manager/lib/I18NMixin.js";import"../simple-icon/simple-icon.js";import"../simple-icon/lib/simple-icons.js";import{SimpleIconsetStore as s}from"../simple-icon/lib/simple-iconset.js";import{pageBreakManager as o}from"./lib/page-break-manager.js";export class PageBreak extends(n(r(a(i)))){static get tag(){return"page-break"}constructor(){super(),this.status="",this.t={newPage:"New page",pageBreak:"Page break",pageDetails:"Page details",clickToUnlock:"Click to unlock"},this.pathAuto=!1,this.title=this.t.newPage,this.slug="#",this.published=!1,this.target=null,this.locked=!1,this.order=null,this.depth=0,this.itemId=null,this._haxState=!1,this.IORemoveOnVisible=!1,this.IODelay=250,this.remoteHeadingobserver=new MutationObserver((()=>{this.title!=this.target.innerText&&(this.__moUpdate=!0,this.title=this.target.innerText)})),this.breakType="node"}static get properties(){let e={};return super.properties&&(e=super.properties),{...e,pathAuto:{type:Boolean,reflect:!0,attribute:"path-auto"},order:{type:Number},title:{type:String,reflect:!0},slug:{type:String},parent:{type:String,reflect:!0},published:{type:Boolean,reflect:!0},locked:{type:Boolean,reflect:!0},depth:{type:Number,reflect:!0},itemId:{type:String,attribute:"item-id",reflect:!0},breakType:{type:String,attribute:"break-type"},status:{type:String},_haxState:{type:Boolean}}}connectedCallback(){super.connectedCallback(),"node"===this.breakType&&(this.nextElementSibling&&this.nextElementSibling.tagName&&["H1","H2","H3","H4","H5","H6"].includes(this.nextElementSibling.tagName)?(this.title=this.nextElementSibling.innerText,this.target=this.nextElementSibling,this.setupTargetData(this.target)):setTimeout((()=>{if(null===this.target)if(this.nextElementSibling&&this.nextElementSibling.tagName&&["H1","H2","H3","H4","H5","H6"].includes(this.nextElementSibling.tagName))this.title=this.nextElementSibling.innerText,this.target=this.nextElementSibling,this.setupTargetData(this.target);else{let e=0===this.depth?"h2":`h${this.depth+2}`,t=document.createElement(e);t.setAttribute("data-original-level","H2"),t.innerText=this.title,this.parentNode.insertBefore(t,this.nextElementSibling),setTimeout((()=>{this.setupTargetData(this.nextElementSibling)}),100)}}),0)),window.dispatchEvent(new CustomEvent("page-break-registration",{composed:!0,bubbles:!0,cancelable:!0,detail:{value:this,action:"add"}})),window.dispatchEvent(new CustomEvent("page-break-change",{composed:!0,bubbles:!0,cancelable:!0,detail:{value:this}}))}disconnectedCallback(){window.dispatchEvent(new CustomEvent("page-break-registration",{detail:{value:this,action:"remove"}})),window.dispatchEvent(new CustomEvent("page-break-change",{composed:!0,bubbles:!0,cancelable:!0,detail:{value:this}})),this.remoteHeadingobserver.disconnect(),super.disconnectedCallback()}setupTargetData(e){this.target&&this.remoteHeadingobserver.disconnect(),this.target=e,this._haxSibling=this,this.remoteHeadingobserver.observe(this.target,{characterData:!0,childList:!0,subtree:!0})}updated(e){super.updated&&super.updated(e),e.forEach(((e,t)=>{var i;("itemId"===t&&null!=this[t]?this.schemaResourceID=this.itemId:"schemaResourceID"===t&&null==this.itemId&&(this.itemId=this.schemaResourceID.replace("#","")),"elementVisible"===t&&this.elementVisible&&this.itemId&&this.shadowRoot&&setTimeout((()=>{o.updateVisibleAsActive()}),0),this.locked&&"locked"===t?o.elementsBetween(this).forEach((e=>{e.setAttribute("data-hax-lock","data-hax-lock")})):!this.locked&&"locked"===t&&e&&o.elementsBetween(this).forEach((e=>{e.removeAttribute("data-hax-lock")})),this._ceMenu&&["locked","parent","published"].includes(t)&&this._updateHAXCEMenu(),["title","parent","slug"].includes(t)&&window.dispatchEvent(new CustomEvent("page-break-change",{composed:!0,bubbles:!0,cancelable:!0,detail:{value:this}})),"node"===this.breakType&&this.target&&("title"===t&&this[t]&&(this.__moUpdate?this.__moUpdate=!1:this.title!=this.target.innerText&&(this.target.innerText=this.title)),!this._haxState&&"depth"===t&&this.depth>=0&&o.elementsBetween(this,"page-break","h1,h2,h3,h4,h5,h6").forEach((e=>{let t=(e.getAttribute("data-original-level")?new Number(e.getAttribute("data-original-level").replace("H","")):new Number(e.tagName.replace("H","")))+this.depth;t=t>6?6:t;const i=document.createElement(`h${t}`);i.setAttribute("data-original-level",e.tagName);for(var a=0,n=e.attributes.length;a<n;++a)i.setAttribute(e.attributes.item(a).nodeName,e.attributes.item(a).nodeValue);i.innerHTML=e.innerHTML,this.setupTargetData(i),e.parentNode.replaceChild(i,e)})),"_haxState"===t&&void 0!==e&&(this._haxState?o.elementsBetween(this,"page-break","h1,h2,h3,h4,h5,h6").forEach((e=>{if(e.getAttribute("data-original-level")){let a=new Number(e.getAttribute("data-original-level").replace("H",""));const n=document.createElement(`h${a}`);for(var t=0,i=e.attributes.length;t<i;++t)n.setAttribute(e.attributes.item(t).nodeName,e.attributes.item(t).nodeValue);n.innerHTML=e.innerHTML,e.parentNode.replaceChild(n,e),this.setupTargetData(n)}})):o.elementsBetween(this,"page-break","h1,h2,h3,h4,h5,h6").forEach((e=>{let t=(e.getAttribute("data-original-level")?new Number(e.getAttribute("data-original-level").replace("H","")):new Number(e.tagName.replace("H","")))+this.depth;t=t>6?6:t;const i=document.createElement(`h${t}`);i.setAttribute("data-original-level",e.tagName);for(var a=0,n=e.attributes.length;a<n;++a)i.setAttribute(e.attributes.item(a).nodeName,e.attributes.item(a).nodeValue);i.innerHTML=e.innerHTML,e.parentNode.replaceChild(i,e),this.setupTargetData(i)})))),"breakType"===t)&&("node"===this[t]?(i=s.getIcon("editor:format-page-break"),this.shadowRoot.querySelector("style").innerHTML=`\n          :host([data-hax-ray]:hover) .mid::before {\n            content: "${this.t.pageBreak}";\n          }`):(i=s.getIcon("hax:page-details"),this.shadowRoot.querySelector("style").innerHTML=`\n          :host([data-hax-ray]:hover) .mid::before {\n            content: "${this.t.pageDetails}";\n          }`),this.style.backgroundImage=`url("${i}")`)}))}static get styles(){return[t`
        :host {
          display: block;
          opacity: 0;
          height: 1px;
        }
        :host([data-hax-ray]) {
          display: block;
          margin: 20px 0;
          padding: 20px;
          opacity: 0.2;
          background-position: center;
          background-repeat: no-repeat;
          transition: all 0.2s linear;
        }
        .mid {
          border: none;
          border-top: 2px solid #cccccc;
          overflow: visible;
          margin: 4px 0 0 0;
          padding: 0;
          height: 0;
        }
        :host([data-hax-ray]:hover) {
          opacity: 1;
        }
        :host([data-hax-ray]:hover) .mid::before {
          font-weight: bold;
          color: #000000;
          background-color: #ffffff;
          font-size: 16px;
          left: calc(50% - 2.5em);
          top: -16px;
          position: relative;
          height: 0;
          line-height: 36px;
        }
        simple-icon-lite {
          float: right;
          color: red;
          --simple-icon-width: 36px;
          --simple-icon-height: 36px;
          margin-top: -28px;
          margin-right: -46px;
        }
      `]}firstUpdated(e){super.firstUpdated&&super.firstUpdated(e)}render(){return e`
      <style>
        :host([data-hax-ray]:hover) .mid::before {
          content: "${this.t.pageBreak}";
        }
      </style>
      <a .href="${this.slug}" .name="#${this.itemId}" aria-hidden="true"></a>
      <hr class="mid" />
      ${this.locked?e`<simple-icon-lite
            @click="${this.haxClickLockInPage}"
            icon="icons:lock"
            title="${this.t.clickToUnlock}"
          ></simple-icon-lite>`:""}
    `}static get haxProperties(){return new URL("./lib/page-break.haxProperties.json",import.meta.url).href}haxHooks(){return{editModeChanged:"haxeditModeChanged",inlineContextMenu:"haxinlineContextMenu",activeElementChanged:"haxactiveElementChanged",setupActiveElementForm:"haxsetupActiveElementForm",preProcessInsertContent:"haxpreProcessInsertContent",trayDragNDropToNode:"haxtrayDragNDropToNode"}}async haxpreProcessInsertContent(e,t){let i=t;for(;"HAX-BODY"!==i.parentNode.tagName;)i=i.parentNode;const a=await o.associatedPageBreak(i);return a&&(e.properties.parent=a.parent,e.properties.order=a.order+1,e.properties.published=a.published,e.properties.locked=a.locked),e}async haxtrayDragNDropToNode(e){let t=e;for(;"HAX-BODY"!==t.parentNode.tagName;)t=t.parentNode;const i=await o.associatedPageBreak(t);i&&(e.parent=i.parent,e.order=i.order+1,e.published=i.published,e.locked=i.locked)}haxsetupActiveElementForm(e){if(window.HAXCMS){const i=window.HAXCMS.requestAvailability().store.getManifestItems(!0);var t=[];i.forEach((e=>{if(e.id!=this.itemId){let a=e,n="- ";for(;a&&null!=a.parent;)a=i.find((e=>e.id==a.parent)),a&&(n="--"+n);t.push({text:n+e.title,value:e.id})}})),e.settings.configure.forEach(((i,a)=>{"parent"===i.property&&(e.settings.configure[a].inputMethod="select",e.settings.configure[a].itemsList=t)}))}}haxactiveElementChanged(e,t){!t&&this._ceMenu&&("site"===this.breakType?(this._ceMenu.disableOps=!1,this._ceMenu.canMoveElement=!0,this._ceMenu.insertAbove=!0):this._ceMenu.disableDuplicate=!1)}haxeditModeChanged(e){this._haxState=e}haxinlineContextMenu(e){this._ceMenu=e,this._updateHAXCEMenu(),"site"===this.breakType?(this._ceMenu.disableOps=!0,this._ceMenu.canMoveElement=!1,this._ceMenu.insertAbove=!1):this._ceMenu.disableDuplicate=!0}_updateHAXCEMenu(){this._ceMenu.ceButtons=[{icon:this.locked?"icons:lock":"icons:lock-open",callback:"haxClickInlineLock",label:"Toggle Lock"},{icon:this.published?"lrn:view":"lrn:view-off",callback:"haxClickInlinePublished",label:"Toggle published"},{icon:"editor:format-indent-increase",callback:"haxIndentParent",label:"Move under parent page break",disabled:!o.getParent(this,"indent")},{icon:"editor:format-indent-decrease",callback:"haxOutdentParent",label:"Move out of parent page break",disabled:!o.getParent(this,"outdent")}]}haxClickLockInPage(e){this.locked=!this.locked,window.dispatchEvent(new CustomEvent("hax-refresh-tray-form",{}))}haxClickInlineLock(e){return this.locked=!this.locked,!0}haxClickInlinePublished(e){return this.published=!this.published,!0}haxIndentParent(e){return o.getParent(this,"indent")&&(this.parent=o.getParent(this,"indent").slug),!0}haxOutdentItem(e){return o.getParent(this,"outdent")?this.parent=o.getParent(this,"outdent").slug:this.parent&&null===o.getParent(this,"outdent")&&(this.parent=null),!0}}customElements.define(PageBreak.tag,PageBreak);