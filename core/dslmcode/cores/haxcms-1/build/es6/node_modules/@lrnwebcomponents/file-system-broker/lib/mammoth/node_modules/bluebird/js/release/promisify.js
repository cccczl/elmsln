module.exports=function(r,e){var t={},n=require("./util"),i=require("./nodeback"),a=n.withAppended,o=n.maybeWrapAsError,s=n.canEvaluate,c=require("./errors").TypeError,l={__isPromisified__:!0},f=new RegExp("^(?:"+["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"].join("|")+")$"),defaultFilter=function(r){return n.isIdentifier(r)&&"_"!==r.charAt(0)&&"constructor"!==r};function propsFilter(r){return!f.test(r)}function isPromisified(r){try{return!0===r.__isPromisified__}catch(r){return!1}}function hasPromisified(r,e,t){var i=n.getDataPropertyOrDefault(r,e+t,l);return!!i&&isPromisified(i)}function promisifiableMethods(r,e,t,i){for(var a=n.inheritedDataKeys(r),o=[],s=0;s<a.length;++s){var l=a[s],f=r[l],u=i===defaultFilter||defaultFilter(l);"function"!=typeof f||isPromisified(f)||hasPromisified(r,l,e)||!i(l,f,r,u)||o.push(l,f)}return function checkValid(r,e,t){for(var n=0;n<r.length;n+=2){var i=r[n];if(t.test(i))for(var a=i.replace(t,""),o=0;o<r.length;o+=2)if(r[o]===a)throw new c("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/MqrFmX\n".replace("%s",e))}}(o,e,t),o}var u=s?function(s,c,l,f,u,p){var m=Math.max(0,function(r){return"number"==typeof r.length?Math.max(Math.min(r.length,1024),0):0}(f)-1),h=function(r){for(var e=[r],t=Math.max(0,r-1-3),n=r-1;n>=t;--n)e.push(n);for(n=r+1;n<=3;++n)e.push(n);return e}(m),d="string"==typeof s||c===t;function generateCallForArgumentCount(r){var e,t=(e=r,n.filledRange(e,"_arg","")).join(", "),i=r>0?", ":"";return(d?"ret = callback.call(this, {{args}}, nodeback); break;\n":void 0===c?"ret = callback({{args}}, nodeback); break;\n":"ret = callback.call(receiver, {{args}}, nodeback); break;\n").replace("{{args}}",t).replace(", ",i)}var g="string"==typeof s?"this != null ? this['"+s+"'] : fn":"fn",y="'use strict';                                                \n        var ret = function (Parameters) {                                    \n            'use strict';                                                    \n            var len = arguments.length;                                      \n            var promise = new Promise(INTERNAL);                             \n            promise._captureStackTrace();                                    \n            var nodeback = nodebackForPromise(promise, "+p+");   \n            var ret;                                                         \n            var callback = tryCatch([GetFunctionCode]);                      \n            switch(len) {                                                    \n                [CodeForSwitchCase]                                          \n            }                                                                \n            if (ret === errorObj) {                                          \n                promise._rejectCallback(maybeWrapAsError(ret.e), true, true);\n            }                                                                \n            if (!promise._isFateSealed()) promise._setAsyncGuaranteed();     \n            return promise;                                                  \n        };                                                                   \n        notEnumerableProp(ret, '__isPromisified__', true);                   \n        return ret;                                                          \n    ".replace("[CodeForSwitchCase]",function generateArgumentSwitchCase(){for(var r="",e=0;e<h.length;++e)r+="case "+h[e]+":"+generateCallForArgumentCount(h[e]);return r+="                                                             \n        default:                                                             \n            var args = new Array(len + 1);                                   \n            var i = 0;                                                       \n            for (var i = 0; i < len; ++i) {                                  \n               args[i] = arguments[i];                                       \n            }                                                                \n            args[i] = nodeback;                                              \n            [CodeForCall]                                                    \n            break;                                                           \n        ".replace("[CodeForCall]",d?"ret = callback.apply(this, args);\n":"ret = callback.apply(receiver, args);\n")}()).replace("[GetFunctionCode]",g);return y=y.replace("Parameters",function(r){return n.filledRange(Math.max(r,3),"_arg","")}(m)),new Function("Promise","fn","receiver","withAppended","maybeWrapAsError","nodebackForPromise","tryCatch","errorObj","notEnumerableProp","INTERNAL",y)(r,f,c,a,o,i,n.tryCatch,n.errorObj,n.notEnumerableProp,e)}:function makeNodePromisifiedClosure(s,c,l,f,u,p){var m=function(){return this}(),h=s;function promisified(){var n=c;c===t&&(n=this);var l=new r(e);l._captureStackTrace();var f="string"==typeof h&&this!==m?this[h]:s,u=i(l,p);try{f.apply(n,a(arguments,u))}catch(r){l._rejectCallback(o(r),!0,!0)}return l._isFateSealed()||l._setAsyncGuaranteed(),l}return"string"==typeof h&&(s=f),n.notEnumerableProp(promisified,"__isPromisified__",!0),promisified};function promisifyAll(r,e,i,a,o){for(var s=new RegExp(e.replace(/([$])/,"\\$")+"$"),c=promisifiableMethods(r,e,s,i),l=0,f=c.length;l<f;l+=2){var p=c[l],m=c[l+1],h=p+e;if(a===u)r[h]=u(p,t,p,m,e,o);else{var d=a(m,(function(){return u(p,t,p,m,e,o)}));n.notEnumerableProp(d,"__isPromisified__",!0),r[h]=d}}return n.toFastProperties(r),r}r.promisify=function(r,e){if("function"!=typeof r)throw new c("expecting a function but got "+n.classString(r));if(isPromisified(r))return r;var i=function promisify(r,e,t){return u(r,e,void 0,r,null,t)}(r,void 0===(e=Object(e)).context?t:e.context,!!e.multiArgs);return n.copyDescriptors(r,i,propsFilter),i},r.promisifyAll=function(r,e){if("function"!=typeof r&&"object"!=typeof r)throw new c("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/MqrFmX\n");var t=!!(e=Object(e)).multiArgs,i=e.suffix;"string"!=typeof i&&(i="Async");var a=e.filter;"function"!=typeof a&&(a=defaultFilter);var o=e.promisifier;if("function"!=typeof o&&(o=u),!n.isIdentifier(i))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/MqrFmX\n");for(var s=n.inheritedDataKeys(r),l=0;l<s.length;++l){var f=r[s[l]];"constructor"!==s[l]&&n.isClass(f)&&(promisifyAll(f.prototype,i,a,o,t),promisifyAll(f,i,a,o,t))}return promisifyAll(r,i,a,o,t)}};