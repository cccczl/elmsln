module.exports=function(e,t,s,r,i,o){var n=require("./util"),u=require("./errors").TypeError,p=require("./util").inherits,l=n.errorObj,a=n.tryCatch,c={};function thrower(e){setTimeout((function(){throw e}),0)}function dispose(t,r){var o=0,n=t.length,u=new e(i);return function iterator(){if(o>=n)return u._fulfill();var i=function castPreservingDisposable(e){var t=s(e);return t!==e&&"function"==typeof e._isDisposable&&"function"==typeof e._getDisposer&&e._isDisposable()&&t._setDisposable(e._getDisposer()),t}(t[o++]);if(i instanceof e&&i._isDisposable()){try{i=s(i._getDisposer().tryDispose(r),t.promise)}catch(e){return thrower(e)}if(i instanceof e)return i._then(iterator,thrower,null,null,null)}iterator()}(),u}function Disposer(e,t,s){this._data=e,this._promise=t,this._context=s}function FunctionDisposer(e,t,s){this.constructor$(e,t,s)}function maybeUnwrapDisposer(e){return Disposer.isDisposer(e)?(this.resources[this.index]._setDisposable(e),e.promise()):e}function ResourceList(e){this.length=e,this.promise=null,this[e-1]=null}Disposer.prototype.data=function(){return this._data},Disposer.prototype.promise=function(){return this._promise},Disposer.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():c},Disposer.prototype.tryDispose=function(e){var t=this.resource(),s=this._context;void 0!==s&&s._pushContext();var r=t!==c?this.doDispose(t,e):null;return void 0!==s&&s._popContext(),this._promise._unsetDisposable(),this._data=null,r},Disposer.isDisposer=function(e){return null!=e&&"function"==typeof e.resource&&"function"==typeof e.tryDispose},p(FunctionDisposer,Disposer),FunctionDisposer.prototype.doDispose=function(e,t){return this.data().call(e,e,t)},ResourceList.prototype._resultCancelled=function(){for(var t=this.length,s=0;s<t;++s){var r=this[s];r instanceof e&&r.cancel()}},e.using=function(){var r=arguments.length;if(r<2)return t("you must pass at least 2 arguments to Promise.using");var i,u=arguments[r-1];if("function"!=typeof u)return t("expecting a function but got "+n.classString(u));var p=!0;2===r&&Array.isArray(arguments[0])?(r=(i=arguments[0]).length,p=!1):(i=arguments,r--);for(var c=new ResourceList(r),f=0;f<r;++f){var h=i[f];if(Disposer.isDisposer(h)){var _=h;(h=h.promise())._setDisposable(_)}else{var D=s(h);D instanceof e&&(h=D._then(maybeUnwrapDisposer,null,null,{resources:c,index:f},void 0))}c[f]=h}var d=new Array(c.length);for(f=0;f<d.length;++f)d[f]=e.resolve(c[f]).reflect();var v=e.all(d).then((function(e){for(var t=0;t<e.length;++t){var s=e[t];if(s.isRejected())return l.e=s.error(),l;if(!s.isFulfilled())return void v.cancel();e[t]=s.value()}y._pushContext(),u=a(u);var r=p?u.apply(void 0,e):u(e),i=y._popContext();return o.checkForgottenReturns(r,i,"Promise.using",y),r})),y=v.lastly((function(){var t=new e.PromiseInspection(v);return dispose(c,t)}));return c.promise=y,y._setOnCancel(c),y},e.prototype._setDisposable=function(e){this._bitField=131072|this._bitField,this._disposer=e},e.prototype._isDisposable=function(){return(131072&this._bitField)>0},e.prototype._getDisposer=function(){return this._disposer},e.prototype._unsetDisposable=function(){this._bitField=-131073&this._bitField,this._disposer=void 0},e.prototype.disposer=function(e){if("function"==typeof e)return new FunctionDisposer(e,this,r());throw new u}};