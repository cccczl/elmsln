import{html as e,css as t}from"../../../lit/index.js";import{SimpleFieldsUpload as o}from"../../simple-fields/lib/simple-fields-upload.js";import{winEventsElement as i}from"../../utils/utils.js";import{HAXStore as a}from"./hax-store.js";import{I18NMixin as l}from"../../i18n-manager/lib/I18NMixin.js";class HaxUploadField extends(i(l(o))){constructor(){super(),this.autocomplete="on",this.__winEvents={"hax-app-picker-selection":"_haxAppPickerSelection"},this.t={whereUpload:"Where would you like to upload this",cantHandle:"Sorry, you don't have a storage location that can handle",uploads:"uploads"},this.registerLocalization({context:this,namespace:"hax"})}static get tag(){return"hax-upload-field"}_canUpload(){return!this.__allowUpload&&a}_fileAboutToUpload(e){if(this._canUpload()){e.preventDefault(),e.stopPropagation();let o={source:e.detail.file.name,type:e.detail.file.type};var t=a.guessGizmoType(o);let i=a.getHaxAppStoreTargets(t);1===i.length?this._haxAppPickerSelection({detail:i[0]}):0!==i.length?a.haxAppPicker.presentOptions(i,t,`${this.t.whereUpload} ${t}?`,"app"):"document"===t&&"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e.detail.file.type?import("../../file-system-broker/lib/docx-file-system-broker.js").then((()=>{window.DOCXFileSystemBroker.requestAvailability().fileToHTML(e.detail.file,"hax-upload")})):a.toast(`${this.t.cantHandle} ${t} ${this.t.uploads}!`,5e3)}else this.__allowUpload=!1}insertDOCXFileContents(e){if("hax-upload"===e.detail.name){let o=document.createElement("div");o.innerHTML=e.detail.value;let i=!1;a.activeNode.hasAttribute("slot")&&(i=a.activeNode.getAttribute("slot"));for(var t=o.children.length-1;t>0;t--)i&&o.children[t].setAttribute("slot",i),a.activeNode.parentNode.insertBefore(o.children[t],a.activeNode.nextSibling)}}connectedCallback(){super.connectedCallback(),window.addEventListener("docx-file-system-data",this.insertDOCXFileContents.bind(this))}disconnectedCallback(){window.removeEventListener("docx-file-system-data",this.insertDOCXFileContents.bind(this)),super.disconnectedCallback()}_haxAppPickerSelection(e){let t=e.detail.connection;this.__appUsed=e.detail,this.shadowRoot.querySelector("#fileupload").method=t.operations.add.method;let o=t.protocol+"://"+t.url;"/"!=o.substr(o.length-1)&&(o+="/"),void 0!==t.operations.add.endPoint&&(o+=t.operations.add.endPoint),null!=a.connectionRewrites.appendUploadEndPoint&&(o+="?"+a.connectionRewrites.appendUploadEndPoint),null!=a.connectionRewrites.appendJwt&&(o+="&"+a.connectionRewrites.appendJwt+"="+function localStorageGet(e){try{return localStorage.getItem(e)}catch(e){return!1}}(a.connectionRewrites.appendJwt)),this.shadowRoot.querySelector("#fileupload").headers=t.headers,this.shadowRoot.querySelector("#fileupload").target=o,this.__allowUpload=!0,this.shadowRoot.querySelector("#fileupload").uploadFiles()}_fileUploadResponse(e){let t=JSON.parse(e.detail.xhr.response),o=this.__appUsed.connection.operations.add.resultMap,i={},a={};for(var l in void 0!==this._resolveObjectPath(o.item,t)&&(i=this._resolveObjectPath(o.item,t)),a.type=o.defaultGizmoType,o.gizmo)a[l]=this._resolveObjectPath(o.gizmo[l],i);void 0===a.url&&void 0!==a.source&&(a.url=a.source),void 0!==o.gizmo.type&&(a.type=this._resolveObjectPath(o.gizmo.type,i)),this.shadowRoot.querySelector("#url").value=a.url}}customElements.define(HaxUploadField.tag,HaxUploadField);export{HaxUploadField};