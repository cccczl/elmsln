module.exports=function(t,i,e,r,n,s){var o=t._getDomain,u=require("./util"),a=u.tryCatch,p=u.errorObj,l=t._async;function MappingPromiseArray(t,i,e,r){this.constructor$(t),this._promise._captureStackTrace();var s=o();this._callback=null===s?i:u.domainBind(s,i),this._preservedValues=r===n?new Array(this.length()):null,this._limit=e,this._inFlight=0,this._queue=[],l.invoke(this._asyncInit,this,void 0)}function map(i,r,n,s){if("function"!=typeof r)return e("expecting a function but got "+u.classString(r));var o=0;if(void 0!==n){if("object"!=typeof n||null===n)return t.reject(new TypeError("options argument must be an object but it is "+u.classString(n)));if("number"!=typeof n.concurrency)return t.reject(new TypeError("'concurrency' must be a number but it is "+u.classString(n.concurrency)));o=n.concurrency}return new MappingPromiseArray(i,r,o="number"==typeof o&&isFinite(o)&&o>=1?o:0,s).promise()}u.inherits(MappingPromiseArray,i),MappingPromiseArray.prototype._asyncInit=function(){this._init$(void 0,-2)},MappingPromiseArray.prototype._init=function(){},MappingPromiseArray.prototype._promiseFulfilled=function(i,e){var n=this._values,o=this.length(),u=this._preservedValues,l=this._limit;if(e<0){if(n[e=-1*e-1]=i,l>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return!0}else{if(l>=1&&this._inFlight>=l)return n[e]=i,this._queue.push(e),!1;null!==u&&(u[e]=i);var h=this._promise,c=this._callback,_=h._boundValue();h._pushContext();var f=a(c).call(_,i,e,o),m=h._popContext();if(s.checkForgottenReturns(f,m,null!==u?"Promise.filter":"Promise.map",h),f===p)return this._reject(f.e),!0;var y=r(f,this._promise);if(y instanceof t){var g=(y=y._target())._bitField;if(0==(50397184&g))return l>=1&&this._inFlight++,n[e]=y,y._proxy(this,-1*(e+1)),!1;if(0==(33554432&g))return 0!=(16777216&g)?(this._reject(y._reason()),!0):(this._cancel(),!0);f=y._value()}n[e]=f}return++this._totalResolved>=o&&(null!==u?this._filter(n,u):this._resolve(n),!0)},MappingPromiseArray.prototype._drainQueue=function(){for(var t=this._queue,i=this._limit,e=this._values;t.length>0&&this._inFlight<i;){if(this._isResolved())return;var r=t.pop();this._promiseFulfilled(e[r],r)}},MappingPromiseArray.prototype._filter=function(t,i){for(var e=i.length,r=new Array(e),n=0,s=0;s<e;++s)t[s]&&(r[n++]=i[s]);r.length=n,this._resolve(r)},MappingPromiseArray.prototype.preservedValues=function(){return this._preservedValues},t.prototype.map=function(t,i){return map(this,t,i,null)},t.map=function(t,i,e,r){return map(t,i,e,r)}};