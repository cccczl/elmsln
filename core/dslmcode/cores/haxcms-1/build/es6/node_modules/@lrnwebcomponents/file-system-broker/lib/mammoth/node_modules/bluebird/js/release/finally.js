module.exports=function(e,n){var l=require("./util"),t=e.CancellationError,a=l.errorObj;function PassThroughHandlerContext(e,n,l){this.promise=e,this.type=n,this.handler=l,this.called=!1,this.cancelPromise=null}function FinallyHandlerCancelReaction(e){this.finallyHandler=e}function checkCancel(e,n){return null!=e.cancelPromise&&(arguments.length>1?e.cancelPromise._reject(n):e.cancelPromise._cancel(),e.cancelPromise=null,!0)}function succeed(){return finallyHandler.call(this,this.promise._target()._settledValue())}function fail(e){if(!checkCancel(this,e))return a.e=e,a}function finallyHandler(l){var i=this.promise,r=this.handler;if(!this.called){this.called=!0;var c=this.isFinallyHandler()?r.call(i._boundValue()):r.call(i._boundValue(),l);if(void 0!==c){i._setReturnedNonUndefined();var o=n(c,i);if(o instanceof e){if(null!=this.cancelPromise){if(o._isCancelled()){var s=new t("late cancellation observer");return i._attachExtraTrace(s),a.e=s,a}o.isPending()&&o._attachCancellationCallback(new FinallyHandlerCancelReaction(this))}return o._then(succeed,fail,void 0,this,void 0)}}}return i.isRejected()?(checkCancel(this),a.e=l,a):(checkCancel(this),l)}return PassThroughHandlerContext.prototype.isFinallyHandler=function(){return 0===this.type},FinallyHandlerCancelReaction.prototype._resultCancelled=function(){checkCancel(this.finallyHandler)},e.prototype._passThrough=function(e,n,l,t){return"function"!=typeof e?this.then():this._then(l,t,void 0,new PassThroughHandlerContext(this,n,e),void 0)},e.prototype.lastly=e.prototype.finally=function(e){return this._passThrough(e,0,finallyHandler,finallyHandler)},e.prototype.tap=function(e){return this._passThrough(e,1,finallyHandler)},PassThroughHandlerContext};